<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
        <title>SyraID — Autenticação</title>
        <meta name="color-scheme" content="light dark" />
        <link rel="stylesheet" href="../assets/css/mono.css">
        <link rel="stylesheet" href="../assets/css/responsive.css">
    </head>
    <body>
        <main class="container" style="padding:48px 20px;">
            <div class="narrow">
                <h1 style="margin:0 0 8px 0;">SyraID</h1>
                <p class="section-desc" style="margin-bottom:20px;">Entre com seu usuário e código 2FA. Simples, seguro e direto.</p>

                <div id="message-area" class="message" style="display:none"></div>

                <!-- Login View -->
                <div id="login-view">
                    <h2 class="section-title">Login seguro</h2>
                    <form id="login-form" class="form">
                        <div>
                            <label for="login-username">Usuário</label>
                            <input type="text" id="login-username" autocomplete="username" required />
                        </div>
                        <div>
                            <label for="login-totp">Código 2FA</label>
                            <input type="tel" id="login-totp" maxlength="6" pattern="\d{6}" inputmode="numeric" autocomplete="one-time-code" required />
                        </div>
                        <button type="submit" class="button primary block">Entrar</button>
                    </form>
                    <p class="section-desc" style="margin-top:12px">Não tem uma conta? <a href="#" id="show-register-link">Registre-se</a></p>
                </div>

                <!-- Register View -->
                <div id="register-view" style="display:none">
                    <h2 class="section-title">Criar conta</h2>
                    <form id="register-form" class="form">
                        <div id="register-step1">
                            <label for="register-username">Usuário</label>
                            <input type="text" id="register-username" autocomplete="username" required />
                            <button type="submit" class="button primary block">Criar conta</button>
                        </div>
                    </form>

                    <div id="register-step2" style="display:none">
                        <div class="card" style="grid-column:span 12; margin-top:12px;">
                            <p><strong>Escaneie o QR Code no seu app autenticador</strong></p>
                            <img id="qrcode-image" alt="QR Code" style="max-width:180px; border:1px solid var(--border); padding:6px; background: var(--bg); border-radius:8px;">
                            <p style="margin-top:8px">Guarde esta chave de backup:</p>
                            <code id="secret-key" style="display:inline-block; padding:6px 8px; border:1px dashed var(--border); border-radius:6px;"></code>
                        </div>
                        <form id="verify-form" class="form" style="margin-top:16px;">
                            <div>
                                <label for="verify-totp">Código de 6 dígitos</label>
                                <input type="tel" id="verify-totp" maxlength="6" pattern="\d{6}" inputmode="numeric" autocomplete="one-time-code" required />
                            </div>
                            <button type="submit" class="button primary block">Verificar e ativar</button>
                        </form>
                        <p class="section-desc" style="margin-top:12px">Já tem uma conta? <a href="#" id="show-login-link">Faça login</a></p>
                    </div>
                </div>
            </div>
        </main>

        <script>
        const API_URL = 'https://syraid.onrender.com'; // Ajuste o IP se necessário

        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const messageArea = document.getElementById('message-area');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const verifyForm = document.getElementById('verify-form');
        const showRegisterLink = document.getElementById('show-register-link');
        const showLoginLink = document.getElementById('show-login-link');
        const registerStep1 = document.getElementById('register-step1');
        const registerStep2 = document.getElementById('register-step2');
        const qrCodeImage = document.getElementById('qrcode-image');
        const secretKeyEl = document.getElementById('secret-key');

        function showLoginView() {
            loginView.style.display = 'block';
            registerView.style.display = 'none';
            messageArea.style.display = 'none';
            document.getElementById('login-username').focus();
        }

        function showRegisterView() {
            loginView.style.display = 'none';
            registerView.style.display = 'block';
            messageArea.style.display = 'none';
            registerStep1.style.display = 'block';
            registerStep2.style.display = 'none';
            registerForm.reset();
            verifyForm.reset();
            document.getElementById('register-username').focus();
        }

        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showRegisterView(); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showLoginView(); });

                function showMessage(message, type = 'error') {
                    messageArea.textContent = '';
                    messageArea.style.display = 'block';
                    messageArea.className = 'message ' + (type === 'success' ? 'success' : 'error');
                    if (typeof message === 'string') {
                        messageArea.innerHTML = message;
                    } else {
                        messageArea.appendChild(message);
                    }
                    window.scrollTo(0, 0);
                }

        // MELHORIA: Função para controlar o estado do botão (loading)
                function toggleButtonState(button, isLoading, originalText) {
                    if (isLoading) {
                        button.disabled = true;
                        button.textContent = 'Carregando...';
                    } else {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                }
        
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            toggleButtonState(button, true);

            const username = document.getElementById('register-username').value.trim();
            if (!username) {
                showMessage('Por favor, insira um nome de usuário.');
                toggleButtonState(button, false, 'Criar Conta');
                return;
            }
            try {
                // ALTERAÇÃO: Rota corrigida para /auth/register
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Erro ao registrar.');
                
                // MELHORIA: Usar sessionStorage para persistir o username
                sessionStorage.setItem('pendingUsername', username);

                qrCodeImage.src = data.qr_code_image;
                secretKeyEl.textContent = data.secret_backup_key;
                registerStep1.style.display = 'none';
                registerStep2.style.display = 'block';
                document.getElementById('verify-totp').focus();
                messageArea.style.display = 'none';

            } catch (error) {
                showMessage(`<b>Erro:</b> ${error.message}`);
            } finally {
                toggleButtonState(button, false, 'Criar Conta');
            }
        });

        verifyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            toggleButtonState(button, true, 'Verificar e Ativar');
            
            // MELHORIA: Obter username do sessionStorage
            const pendingUsername = sessionStorage.getItem('pendingUsername');
            const totp_code = document.getElementById('verify-totp').value.trim();

            if (!pendingUsername) {
                showMessage('Erro interno. Por favor, reinicie o processo de registro.');
                toggleButtonState(button, false, 'Verificar e Ativar');
                return;
            }

            try {
                // ALTERAÇÃO: Rota corrigida para /auth/verify
                const response = await fetch(`${API_URL}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: pendingUsername, totp_code })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Erro ao verificar o código.');

                showLoginView();
                showMessage(data.message, 'success');
                document.getElementById('login-username').value = pendingUsername;
                
                // MELHORIA: Limpar sessionStorage
                sessionStorage.removeItem('pendingUsername');

            } catch (error) {
                showMessage(`<b>Erro:</b> ${error.message}`);
            } finally {
                toggleButtonState(button, false, 'Verificar e Ativar');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            toggleButtonState(button, true, 'Entrar');
            
            const username = document.getElementById('login-username').value.trim();
            const totp_code = document.getElementById('login-totp').value.trim();

            try {
                // ALTERAÇÃO: Rota corrigida para /auth/login
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, totp_code })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Erro no login.');

                if (data.token) {
                    localStorage.setItem('syra-auth-token', data.token);
                    window.location.href = 'dashboard.html'; // Supondo que você terá uma página de dashboard
                } else {
                    throw new Error('Não foi possível obter o token de autenticação.');
                }
            } catch (error) {
                showMessage(`<b>Falha no login:</b> ${error.message}`);
            } finally {
                toggleButtonState(button, false, 'Entrar');
            }
        });
        
        // Verifica se já existe um token e tenta redirecionar
                if (localStorage.getItem('syra-auth-token')) {
                    window.location.href = 'dashboard.html';
                } else {
                    showLoginView();
                }
        </script>
        <script src="../assets/js/responsive.js"></script>
    </body>
</html>
