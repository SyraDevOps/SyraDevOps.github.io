<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LunaGPT — SyraDevOps</title>
    <meta name="color-scheme" content="light dark" />
    <link rel="preload" href="../assets/css/mono.css" as="style" />
    <link rel="stylesheet" href="../assets/css/mono.css" />
    <style>
      /* Ajustes locais mínimos para o chat */
      .chat-hero { padding: 40px 0; }
      .chat-container { display: flex; gap: 24px; align-items: flex-start; }
      .chat-panel { flex: 1 1 680px; background: var(--surface, #fff); border-radius: 12px; padding: 18px; box-shadow: var(--shadow, 0 6px 20px rgba(0,0,0,0.06)); max-height: 68vh; display:flex; flex-direction:column; }
      .chat-window { overflow:auto; flex:1 1 auto; padding-right:8px; margin-bottom:12px; }
      .msg { margin: 8px 0; max-width:80%; padding:10px 12px; border-radius:10px; line-height:1.4; }
      .msg.user { background: var(--accent, #111827); color: #fff; margin-left:auto; border-bottom-right-radius:4px; }
      .msg.bot { background: var(--muted, #f3f4f6); color: var(--text, #111); border-bottom-left-radius:4px; }
      .chat-controls { display:flex; gap:8px; align-items:center; }
      .chat-controls textarea { flex:1 1 auto; min-height:48px; resize:vertical; padding:10px; border-radius:8px; border:1px solid #ddd; }
      .meta { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
      .sidebar { width:260px; min-width:200px; }
      .small-muted { color: #6b7280; font-size:0.9rem; }
      .model-select { padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; }
      .typing { font-style:italic; color: #6b7280; margin:6px 0; }
      @media (max-width:900px) {
        .chat-container { flex-direction:column; }
        .sidebar { width:100%; order:2; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container nav">
        <div class="left">
          <a class="brand" href="../index.html">@SyraDevOps</a>
        </div>
        <nav>
          <ul class="menu">
            <li><a href="../index.html#intro">Início</a></li>
            <li><a href="../Products/All_products.html">Produtos</a></li>
            <li><a href="../SyraX/SyraX.html">SyraX</a></li>
            <li><a href="../index.html#contato">Contato</a></li>
          </ul>
        </nav>
        <div class="right">
          <a class="button small" href="../SyraID/">Login SyraID</a>
          <button id="theme-toggle" class="toggle" aria-pressed="false" aria-label="Alternar tema">Escuro</button>
        </div>
      </div>
    </header>

    <main>
      <section id="intro" class="hero chat-hero">
        <div class="container">
          <div class="chat-container">
            <div class="chat-panel" role="region" aria-label="Janela de chat com Luna">
              <div class="meta">
                <h2 style="margin:0">LunaGPT</h2>
                <div class="small-muted">Converse com o modelo Luna</div>
                <div style="margin-left:auto" class="small-muted" id="user-badge" aria-live="polite">Visitante</div>
              </div>

              <div class="chat-window" id="chat-window" tabindex="0" aria-live="polite" aria-atomic="false">
                <!-- mensagens adicionadas dinamicamente -->
                <div class="typing" id="typing-indicator" style="display:none">Luna está digitando...</div>
              </div>

              <div style="margin-top:8px">
                <div class="meta">
                  <label for="model-select" class="small-muted" style="margin-right:6px">Modelo</label>
                  <select id="model-select" class="model-select" aria-label="Selecionar modelo"></select>

                  <label for="context-input" class="small-muted" style="margin-left:12px">Contexto</label>
                  <input id="context-input" placeholder="Contexto opcional (ex: projeto, persona)" style="padding:8px;border-radius:8px;border:1px solid #ddd;" />
                  <button id="set-context" class="button" style="margin-left:6px">Definir</button>
                  <button id="clear-context" class="button" style="margin-left:6px">Limpar</button>
                </div>

                <div class="chat-controls">
                  <textarea id="message-input" placeholder="Digite sua mensagem para Luna..." aria-label="Mensagem"></textarea>
                  <button id="send-btn" class="button primary">Enviar</button>
                </div>
              </div>
            </div>

            <aside class="sidebar">
              <div style="background:#fff;padding:14px;border-radius:12px;box-shadow:var(--shadow, 0 6px 20px rgba(0,0,0,0.04));">
                <h3 style="margin-top:0">Sobre</h3>
                <p class="small-muted">Luna é um assistente baseado em IA. Use para prototipagem e testes. Respeite limites de privacidade ao enviar dados sensíveis.</p>
                <hr />
                <h4 style="margin:8px 0 6px">Histórico da sessão</h4>
                <div id="history-list" class="small-muted" style="font-size:0.95rem; max-height:38vh; overflow:auto;"></div>
                <div style="margin-top:8px; display:flex; gap:8px;">
                  <button id="clear-history" class="button">Limpar histórico</button>
                  <a class="button" href="../Products/All_products.html">Ver produtos</a>
                </div>
              </div>
            </aside>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div class="container">
        <small>&copy; SyraDevOps. Preto e branco. Simples e direto.</small>
      </div>
    </footer>

    <script src="../assets/js/mono.js" defer></script>
    <script>
(function () {
  // Config
  const API_BASE = 'https://api-lunagpt.onrender.com'; // endpoint fornecido
  const TOKEN_KEY = 'syra-auth-token';

  // Elements
  const modelSelect = document.getElementById('model-select');
  const sendBtn = document.getElementById('send-btn');
  const msgInput = document.getElementById('message-input');
  const chatWindow = document.getElementById('chat-window');
  const typingIndicator = document.getElementById('typing-indicator');
  const historyList = document.getElementById('history-list');
  const clearHistoryBtn = document.getElementById('clear-history');
  const contextInput = document.getElementById('context-input');
  const setContextBtn = document.getElementById('set-context');
  const clearContextBtn = document.getElementById('clear-context');
  const userBadge = document.getElementById('user-badge');

  // Simple in-memory session history (also store in sessionStorage)
  let sessionHistory = JSON.parse(sessionStorage.getItem('lunagpt_history') || '[]');
  let currentContext = sessionStorage.getItem('lunagpt_context') || null;

  // Replace login link with username if token exists (replicando comportamento do index)
  (function loadUserName() {
    const links = Array.from(document.querySelectorAll('a[href*="SyraID"]'));
    if (!links.length) return;
    const token = localStorage.getItem(TOKEN_KEY);
    if (!token) return;
    // Try to fetch profile
    fetch('https://syraid.onrender.com/me/profile', { headers: { 'Authorization': 'Bearer ' + token }})
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(user => {
        const name = user.name || user.username || user.email || 'Usuário';
        links.forEach(a => {
          const orig = a.getAttribute('href') || '../SyraID/';
          const base = orig.endsWith('/') ? orig.slice(0, -1) : orig;
          a.textContent = name;
          a.setAttribute('href', base + '/dashboard.html');
          a.classList.add('user-link');
        });
        userBadge.textContent = name;
      })
      .catch(() => {
        // keep default
      });
  })();

  // Helpers
  function sanitize(text) {
    const tmp = document.createElement('div');
    tmp.textContent = text;
    return tmp.innerHTML;
  }

  function appendMessage(text, who = 'bot') {
    const div = document.createElement('div');
    div.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
    div.innerHTML = sanitize(text).replace(/\n/g, '<br/>');
    chatWindow.insertBefore(div, typingIndicator);
    chatWindow.scrollTop = chatWindow.scrollHeight;
    // save history
    sessionHistory.push({ who, text, time: new Date().toISOString() });
    sessionStorage.setItem('lunagpt_history', JSON.stringify(sessionHistory));
    renderHistoryList();
  }

  function renderHistoryList() {
    historyList.innerHTML = sessionHistory.map((m, i) => {
      const who = m.who === 'user' ? 'Você' : 'Luna';
      const short = m.text.length > 120 ? m.text.slice(0, 117) + '…' : m.text;
      return `<div style="margin-bottom:6px"><strong>${i+1}. ${who}:</strong> ${sanitize(short)}</div>`;
    }).join('');
  }

  function setTyping(on=true) {
    typingIndicator.style.display = on ? 'block' : 'none';
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  // Load models
  async function loadModels() {
    modelSelect.innerHTML = '<option>Carregando...</option>';
    try {
      const res = await fetch(API_BASE + '/api/models');
      if (!res.ok) throw new Error('Falha ao obter modelos');
      const models = await res.json();
      if (!models || models.length === 0) {
        modelSelect.innerHTML = '<option value="">default</option>';
        return;
      }
      modelSelect.innerHTML = models.map(m => `<option value="${sanitize(m)}">${sanitize(m)}</option>`).join('');
      // keep previously selected if any
      const prev = sessionStorage.getItem('lunagpt_model');
      if (prev) modelSelect.value = prev;
    } catch (err) {
      modelSelect.innerHTML = '<option value="">(erro ao carregar)</option>';
      console.error(err);
    }
  }

  // Set and clear context
  setContextBtn.addEventListener('click', () => {
    currentContext = contextInput.value || null;
    sessionStorage.setItem('lunagpt_context', currentContext || '');
    alert(currentContext ? 'Contexto definido.' : 'Contexto vazio.');
  });
  clearContextBtn.addEventListener('click', () => {
    currentContext = null;
    contextInput.value = '';
    sessionStorage.removeItem('lunagpt_context');
    alert('Contexto limpo.');
  });

  // Send message
  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  async function sendMessage() {
    const text = msgInput.value.trim();
    if (!text) return;
    const modelName = modelSelect.value || null;
    const contextToSend = (contextInput.value || currentContext) || null;

    // UI updates
    appendMessage(text, 'user');
    msgInput.value = '';
    sessionStorage.setItem('lunagpt_model', modelName || '');
    setTyping(true);

    try {
      const payload = {
        message: text,
        context: contextToSend,
        model_name: modelName
      };
      const res = await fetch(API_BASE + '/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error('Erro ' + res.status + ': ' + txt);
      }
      const json = await res.json();
      const reply = json.response || '(sem resposta)';
      appendMessage(reply, 'bot');
      // save context returned by API if any
      if (json.context) {
        currentContext = json.context;
        sessionStorage.setItem('lunagpt_context', currentContext);
        contextInput.value = currentContext;
      }
    } catch (err) {
      console.error(err);
      appendMessage('Erro: não foi possível obter resposta. ' + (err.message || ''), 'bot');
    } finally {
      setTyping(false);
    }
  }

  clearHistoryBtn.addEventListener('click', () => {
    if (!confirm('Limpar histórico da sessão?')) return;
    sessionHistory = [];
    sessionStorage.removeItem('lunagpt_history');
    renderHistoryList();
    chatWindow.querySelectorAll('.msg').forEach(n => n.remove());
  });

  // Inicialização
  (function init() {
    // Restore history display
    renderHistoryList();
    // restore context input
    if (currentContext) contextInput.value = currentContext;
    loadModels();
    // focus
    msgInput.focus();
  })();

})();
    </script>
  </body>
</html>